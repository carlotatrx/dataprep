skip =4,
sep=",",
na="-9999") %>%
rename(
p=5,
rr=6,
ta=7,
tawet=8,
w=9,
rh=10
) %>%
mutate(
Minute=0
)
head(raw)
raw <- read.delim(file,
skip =4,
sep=",",
na="-9999") %>%
rename(
p.orig=5,
rr=6,
ta=7,
tawet=8,
w=9,
rh=10
) %>%
mutate(
Minute=0
)
raw <- read.delim(file,
skip =4,
sep=",",
na="-9999") %>%
rename(
p.orig=5,
rr=6,
ta=7,
tawet=8,
w=9,
rh=10
) %>%
mutate(
Minute=0,
p = round(convert_pressure(p.orig,f=0.75006156130264, lat=lat, alt=alt, atb=ta),2),
meta_time=paste0("orig.time=",Hour),
meta_p = paste0(meta_time, " | orig=", p.orig, "mbar | atb=",ta, "C")
)
head(raw)
convert_pressure
p_to_slp <- function(p_hpa, z_m, T_C, lapse_K_per_m = 0.0065) {
g0 <- 9.80665
Rd <- 287.05
T0 <- T_C + 273.15
# mean temperature of the layer (simple lapse-rate approximation)
T_layer <- T0 - 0.5 * lapse_K_per_m * z_m
p_hpa * exp((g0 * z_m) / (Rd * T_layer))
}
raw <- read.delim(file,
skip =4,
sep=",",
na="-9999") %>%
rename(
p.orig=5,
rr=6,
ta=7,
tawet=8,
w=9,
rh=10
) %>%
mutate(
Minute=0,
p = round(p_to_slp(p.orig, z_m = alt, T_C = ta), 2),
meta_time=paste0("orig.time=",Hour),
meta_p = paste0(meta_time, " | orig=", p.orig, "mbar | atb=",ta, "C")
)
head(raw)
for (var in c('rr', 'ta', 'p', 'w', 'rh')) {
df <- as.data.frame(raw[,c("Year","Month", "Day", "Hour", "Minute", var)]) %>% drop_na(any_of(var))
filename <- outfile.name(name, var, df, FALSE)
filename_full <- paste0(filename, ".tsv")
write_sef_f(
df,
outfile = filename,
outpath = outdir,
cod     = code,
lat     = lat,
lon     = lon,
alt     = alt,
sou     = source,
link    = link,
nam     = name,
var     = var,
stat    = "point",
units   = ifelse(var=="w", "Ben Nevis scale", units(var)),
meta    = ifelse(var==p, df$meta_p, df$meta_time),
keep_na = FALSE
)
}
raw <- read.delim(file,
skip =4,
sep=",",
na="-9999") %>%
rename(
p.orig=5,
rr=6,
ta=7,
tawet=8,
w=9,
rh=10
) %>%
mutate(
Minute=0,
p = round(p_to_slp(p.orig, z_m = alt, T_C = ta), 2),
meta_time=paste0("orig.time=",Hour),
meta_p = paste0(meta_time, " | orig=", p.orig, "mbar | atb=",ta, "C")
)
head(raw)
for (var in c('rr', 'ta', 'p', 'w', 'rh')) {
df <- as.data.frame(raw[,c("Year","Month", "Day", "Hour", "Minute", var)]) %>% drop_na(any_of(var))
filename <- outfile.name(name, var, df, FALSE)
filename_full <- paste0(filename, ".tsv")
write_sef_f(
df,
outfile = filename,
outpath = outdir,
cod     = code,
lat     = lat,
lon     = lon,
alt     = alt,
sou     = source,
link    = link,
nam     = name,
var     = var,
stat    = "point",
units   = ifelse(var=="w", "Ben Nevis scale", units(var)),
meta    = ifelse(var=="p", df$meta_p, df$meta_time),
keep_na = FALSE
)
}
var\
var
df <- as.data.frame(raw[,c("Year","Month", "Day", "Hour", "Minute", var)]) %>% drop_na(any_of(var))
df
filename <- outfile.name(name, var, df, FALSE)
filename_full <- paste0(filename, ".tsv")
write_sef_f(
df,
outfile = filename,
outpath = outdir,
cod     = code,
lat     = lat,
lon     = lon,
alt     = alt,
sou     = source,
link    = link,
nam     = name,
var     = var,
stat    = "point",
units   = ifelse(var=="w", "Ben Nevis scale", units(var)),
meta    = ifelse(var=="p", df$meta_p, df$meta_time),
keep_na = FALSE
)
df
df$meta_time
head(raw)
for (var in c('rr', 'ta', 'p', 'w', 'rh')) {
meta_col <- if (var == "p") "meta_p" else "meta_time"
df <- raw %>%
select(Year, Month, Day, Hour, Minute, all_of(var), all_of(meta_col)) %>%
rename(Value = all_of(var), Meta = all_of(meta_col)) %>%
drop_na(Value)
# df <- as.data.frame(raw[,c("Year","Month", "Day", "Hour", "Minute", var)]) %>% drop_na(any_of(var))
filename <- outfile.name(name, var, df, FALSE)
filename_full <- paste0(filename, ".tsv")
write_sef_f(
df,
outfile = filename,
outpath = outdir,
cod     = code,
lat     = lat,
lon     = lon,
alt     = alt,
sou     = source,
link    = link,
nam     = name,
var     = var,
stat    = "point",
units   = ifelse(var=="w", "Ben Nevis scale", units(var)),
meta    = ifelse(var=="p", df$meta_p, df$meta_time),
keep_na = FALSE
)
}
df
head(df)
for (var in c('rr', 'ta', 'p', 'w', 'rh')) {
meta_col <- if (var == "p") "meta_p" else "meta_time"
df <- raw %>%
select(Year, Month, Day, Hour, Minute, all_of(var), all_of(meta_col)) %>%
rename(Value = all_of(var), Meta = all_of(meta_col)) %>%
drop_na(Value)
# df <- as.data.frame(raw[,c("Year","Month", "Day", "Hour", "Minute", var)]) %>% drop_na(any_of(var))
filename <- outfile.name(name, var, df, FALSE)
filename_full <- paste0(filename, ".tsv")
write_sef_f(
df,
outfile = filename,
outpath = outdir,
cod     = code,
lat     = lat,
lon     = lon,
alt     = alt,
sou     = source,
link    = link,
nam     = name,
var     = var,
stat    = "point",
units   = ifelse(var=="w", "Ben Nevis scale", units(var)),
meta    = df$Meta,
keep_na = FALSE
)
}
for (var in c('rr', 'ta', 'p', 'w', 'rh')) {
meta_col <- if (var == "p") "meta_p" else "meta_time"
df <- raw %>%
select(Year, Month, Day, Hour, Minute, all_of(var), all_of(meta_col)) %>%
rename(Value = all_of(var), Meta = all_of(meta_col)) %>%
drop_na(Value)
# df <- as.data.frame(raw[,c("Year","Month", "Day", "Hour", "Minute", var)]) %>% drop_na(any_of(var))
filename <- outfile.name(name, var, df, TRUE)
filename_full <- paste0(filename, ".tsv")
write_sef_f(
df,
outfile = filename,
outpath = outdir,
cod     = code,
lat     = lat,
lon     = lon,
alt     = alt,
sou     = source,
link    = link,
nam     = name,
var     = var,
stat    = "point",
units   = ifelse(var=="w", "Ben Nevis scale", units(var)),
meta    = df$Meta,
keep_na = FALSE
)
}
indir <- '/scratch3/PALAEO-RA/daily_data/final/'
### quick one
dirname <- "Ben_Nevis/"
dirname <- "Ben_Nevis/"
for (var in c('rr', 'ta', 'p', 'w', 'rh')) {
meta_col <- if (var == "p") "meta_p" else "meta_time"
df <- raw %>%
select(Year, Month, Day, Hour, Minute, all_of(var), all_of(meta_col)) %>%
rename(Value = all_of(var), Meta = all_of(meta_col)) %>%
drop_na(Value)
filename <- outfile.name(name, var, df, TRUE)
filename_full <- paste0(filename, ".tsv")
write_sef_f(
df,
outfile = filename,
outpath = outdir,
cod     = code,
lat     = lat,
lon     = lon,
alt     = alt,
sou     = source,
link    = link,
nam     = name,
var     = var,
stat    = "point",
units   = ifelse(var=="w", "Ben Nevis scale", units(var)),
meta    = df$Meta,
metaHead = ifelse(var=="p", "PTC=Y | PGC=Y", ""),
keep_na = FALSE
)
qc(glue(indir,dirname,filename_full), outpath=glue(indir, dirname))
qcfilename <- paste0("qc_BEN NEVIS SUMMIT OBSERVATORY_",var,"_subdaily.txt")
write_flags_f(infile=glue(indir,dirname,filename_full),
qcfile=glue(indir,dirname, qcfilename),
outpath=glue(indir,dirname),
match=FALSE)
}
var<-'rh'
meta_col <- if (var == "p") "meta_p" else "meta_time"
df <- raw %>%
select(Year, Month, Day, Hour, Minute, all_of(var), all_of(meta_col)) %>%
rename(Value = all_of(var), Meta = all_of(meta_col)) %>%
drop_na(Value)
filename <- outfile.name(name, var, df, TRUE)
filename_full <- paste0(filename, ".tsv")
write_sef_f(
df,
outfile = filename,
outpath = outdir,
cod     = code,
lat     = lat,
lon     = lon,
alt     = alt,
sou     = source,
link    = link,
nam     = name,
var     = var,
stat    = "point",
units   = ifelse(var=="w", "Ben Nevis scale", units(var)),
meta    = df$Meta,
metaHead = ifelse(var=="p", "PTC=Y | PGC=Y", ""),
keep_na = FALSE
)
qc(glue(indir,dirname,filename_full), outpath=glue(indir, dirname))
d
for (var in c('rh', 'w')){#r', 'ta', 'p', 'w', 'rh')) {
meta_col <- if (var == "p") "meta_p" else "meta_time"
df <- raw %>%
select(Year, Month, Day, Hour, Minute, all_of(var), all_of(meta_col)) %>%
rename(Value = all_of(var), Meta = all_of(meta_col)) %>%
drop_na(Value)
filename <- outfile.name(name, var, df, TRUE)
filename_full <- paste0(filename, ".tsv")
write_sef_f(
df,
outfile = filename,
outpath = outdir,
cod     = code,
lat     = lat,
lon     = lon,
alt     = alt,
sou     = source,
link    = link,
nam     = name,
var     = var,
stat    = "point",
units   = ifelse(var=="w", "Ben Nevis scale", units(var)),
meta    = df$Meta,
metaHead = ifelse(var=="p", "PTC=Y | PGC=Y", ""),
keep_na = FALSE
)
qc(glue(indir,dirname,filename_full), outpath=glue(indir, dirname))
qcfilename <- paste0("qc_BEN NEVIS SUMMIT OBSERVATORY_",var,"_subdaily.txt")
write_flags_f(infile=glue(indir,dirname,filename_full),
qcfile=glue(indir,dirname, qcfilename),
outpath=glue(indir,dirname),
match=FALSE)
}
indir <- '/scratch3/PALAEO-RA/daily_data/final/'
### quick one
dirname <- "Channel_Island/"
filename <- "Weather-data-rescue-v2-2_Langlois_Channel-Island_18650101-18751231_p_subdaily.tsv"
qc(glue(indir,dirname,filename), outpath=glue(indir, dirname))
filename <- "Weather-data-rescue-v2-2_Unknown_Channel-Island_18640101-18641002_p_subdaily.tsv"
qc(glue(indir,dirname,filename), outpath=glue(indir, dirname))
filename <- "Weather-data-rescue-v2-2_Vibert_Channel-Island_18760101-18860131_p_subdaily.tsv"
qc(glue(indir,dirname,filename), outpath=glue(indir, dirname))
qcfilename <- "qc_JERSEY-CHANNEL-ISLAND-VIBERT_p_subdaily.txt"
write_flags_f(infile=glue(indir,dirname,filename),
qcfile=glue(indir,dirname, qcfilename),
outpath=glue(indir,dirname),
match=FALSE)
### loop
indir <- "/scratch3/PALAEO-RA/daily_data/final/Aberdeen/"
files <- list.files(indir, pattern = "\\.tsv$", full.names = TRUE)
files
for (f in files) {
qc(f, outpath = indir)
qcfile <- file.path(
indir,
paste0("qc_", tools::file_path_sans_ext(basename(f)), ".txt")
)
write_flags_f(
infile  = f,
qcfile  = qcfile,
outpath = indir,
match   = FALSE
)
}
?qc
qc
### loop
dir <- "/scratch3/PALAEO-RA/daily_data/final/Aberdeen/"
tsv_files <- list.files(dir, pattern="\\.tsv$", full.names=TRUE)
qc_files  <- list.files(dir, pattern="^qc_.*\\.txt$", full.names=TRUE)
# helpers -------------------------------------------------------------
get_res <- function(x) {
if (grepl("_subdaily\\b", x)) "subdaily"
else if (grepl("_daily\\b", x)) "daily"
else NA_character_
}
get_var_data <- function(x) {
bn <- basename(x)
# WDRv2.2_Aberdeen_18610301-18750331_ta_bis_subdaily.tsv  -> ta_bis
sub("^.*_([A-Za-z][A-Za-z0-9]*)_(subdaily|daily)\\.tsv$", "\\1", bn)
}
get_var_qc <- function(x) {
bn <- basename(x)
# qc_DWRUK_ABERDEEN_Tn_daily.txt -> Tn
sub("^qc_.*?_([A-Za-z][A-Za-z0-9]*)_(subdaily|daily)\\.txt$", "\\1", bn)
}
norm_var <- function(v) {
# adjust here if you want ta_bis to use ta QC rules
if (v == "ta_bis") "ta" else v
}
# build QC lookup: key = "var|res" -----------------------------------
qc_key <- paste0(norm_var(get_var_qc(qc_files)), "|", get_res(qc_files))
qc_map <- setNames(qc_files, qc_key)
# build QC lookup: key = "var|res" -----------------------------------
qc_key <- paste0(norm_var(get_var_qc(qc_files)), "|", get_res(qc_files))
for (f in files) {
qc(f, outpath = indir)
qcfile <- file.path(
indir,
paste0("qc_", tools::file_path_sans_ext(basename(f)), ".txt")
)
}
qc_files  <- list.files(indir, pattern="^qc_.*\\.txt$", full.names=TRUE)
qc_files
files
### loop
indir <- "/scratch3/PALAEO-RA/daily_data/final/Aberdeen"
indir <- '/scratch3/PALAEO-RA/daily_data/final/'
### quick one
dirname <- "Aberdeen"
files <- list.files(indir, pattern = "\\.tsv$", full.names = TRUE)
files
files <- list.files(paste0(indir, dirname, sep="/"), pattern = "\\.tsv$", full.names = TRUE)
fiels
files
files <- list.files(paste0(indir, dirname), pattern = "\\.tsv$", full.names = TRUE)
files
for (f in files) {
qc(f, outpath = indir)
qcfile <- file.path(
indir,
paste0("qc_", tools::file_path_sans_ext(basename(f)), ".txt")
)
}
qc_files  <- list.files(paste0(indir, dirname), pattern="^qc_.*\\.txt$", full.names=TRUE)
qc_files
files
qc_files
filename <- "WDRv2.2_Aberdeen_18611211-18750331_rr_daily.tsv"
qc(glue(indir,dirname,filename), outpath=glue(indir, dirname))
qcfilename <- "qc_DWRUK_ABERDEEN_rr_subdaily.txt"
write_flags_f(infile=glue(indir,dirname,filename),
qcfile=glue(indir,dirname, qcfilename),
outpath=glue(indir,dirname),
match=FALSE)
### quick one
dirname <- "Aberdeen/"
write_flags_f(infile=glue(indir,dirname,filename),
qcfile=glue(indir,dirname, qcfilename),
outpath=glue(indir,dirname),
match=FALSE)
qcfilename <- "qc_DWRUK_ABERDEEN_ta_subdaily.txt"
filename <- "WDRv2.2_Aberdeen_18610301-18750331_ta_subdaily.tsv"
qc(glue(indir,dirname,filename), outpath=glue(indir, dirname))
qcfilename <- "qc_DWRUK_ABERDEEN_ta_subdaily.txt"
write_flags_f(infile=glue(indir,dirname,filename),
qcfile=glue(indir,dirname, qcfilename),
outpath=glue(indir,dirname),
match=FALSE)
filename <- "WDRv2.2_Aberdeen_18610301-18750331_ta_bis_subdaily.tsv"
qc(glue(indir,dirname,filename), outpath=glue(indir, dirname))
qcfilename <- "qc_DWRUK_ABERDEEN_ta_subdaily.txt"
write_flags_f(infile=glue(indir,dirname,filename),
qcfile=glue(indir,dirname, qcfilename),
outpath=glue(indir,dirname),
match=FALSE)
filename <- "WDRv2.2_Aberdeen_18610301-18750331_ta_bis_subdaily.tsv"
qc(glue(indir,dirname,filename), outpath=glue(indir, dirname))
filename <- "WDRv2.2_Aberdeen_18720114-18750331_Tn_daily.tsv"
qcfilename <- "qc_DWRUK_ABERDEEN_Tn_daily.txt"
write_flags_f(infile=glue(indir,dirname,filename),
qcfile=glue(indir,dirname, qcfilename),
outpath=glue(indir,dirname),
match=FALSE)
filename <- "WDRv2.2_Aberdeen_18720114-18750331_Tx_daily.tsv"
qcfilename <- "qc_DWRUK_ABERDEEN_Tx_daily.txt"
write_flags_f(infile=glue(indir,dirname,filename),
qcfile=glue(indir,dirname, qcfilename),
outpath=glue(indir,dirname),
match=FALSE)
### loop
indir <- "/scratch3/PALAEO-RA/daily_data/final/Androssan"
files <- list.files(paste0(indir, dirname), pattern = "\\.tsv$", full.names = TRUE)
files
indir <- '/scratch3/PALAEO-RA/daily_data/final/'
### quick one
dirname <- "Androssan/"
files <- list.files(paste0(indir, dirname), pattern = "\\.tsv$", full.names = TRUE)
files
indir <- '/scratch3/PALAEO-RA/daily_data/final/'
### quick one
dirname <- "Androssan/"
files <- list.files(paste0(indir, dirname), pattern = "\\.tsv$", full.names = TRUE)
files
indir
### quick one
dirname <- "Ardrossan/"
files <- list.files(paste0(indir, dirname), pattern = "\\.tsv$", full.names = TRUE)
files
for (f in files) {
qc(f, outpath = indir)
qcfile <- file.path(
indir,
paste0("qc_", tools::file_path_sans_ext(basename(f)), ".txt")
)
}
qc_files  <- list.files(paste0(indir, dirname), pattern="^qc_.*\\.txt$", full.names=TRUE)
qc_files
