" Rijnlandse_inch.line | atb=", ta, "C")
} else if (p_mode == "mmHg10") {
p <- round(convert_pressure(as.numeric(df$porig)/10, lat = lat, alt = alt, atb = ta), 1)
meta.p <- paste0(df$meta.time, " | orig.p=", as.numeric(df$porig)/10, "mmHg | atb=", ta, "C")
} else if (p_mode == "mmHg100") {
p <- round(convert_pressure(as.numeric(df$porig)/100, lat = lat, alt = alt, atb = ta), 1)
meta.p <- paste0(df$meta.time, " | orig.p=", as.numeric(df$porig)/100, "mmHg | atb=", ta, "C")
}
}
# debug for wrong data
if (!is.null(p)) {
print(df[!is.na(p) & p < 900, c("Year", "Month", "Day")])
} else {
print("No pressure recorded in this station.")
}
rr_origunit <- ifelse(!is.na(rr_factor) & rr_factor == 0.1, "mm", "l")
tibble(
Year = df$Year, Month = df$Month, Day = df$Day, Hour = df$Hour, Minute = df$Minute,
dd = dd, ta = ta, p = p, rr = rr, rh = rh,
meta.dd = paste0(df$meta.time, " | orig.dd=", df$ddorig),
meta.rh = df$meta.time,
meta.ta = paste0(df$meta.time, " | orig.ta=",
dplyr::case_when(
ta_scale == "F10" ~ as.numeric(df$taorig)/10,
ta_scale == "F1"  ~ as.numeric(df$taorig),
ta_scale == "C10" ~ as.numeric(df$taorig)/10,
ta_scale == "C1"  ~ df$taorig,
ta_scale == "MIX_1836F10_else_C10" & df$Year == 1836 ~ as.numeric(df$taorig)/10,
TRUE ~ as.numeric(df$taorig)/10
),
ifelse(ta_scale == "F10" | ta_scale =="F1" | (ta_scale == "MIX_1836F10_else_C10" & df$Year == 1836),
"F", "C")),
meta.rr = if (!is.null(rr)) paste0(df$meta.time, " | orig.rr=", df$rrorig/10, rr_origunit) else NA_character_,
meta.p  = meta.p
)
}
# ---- 4) A single writer for multiple variables ------------------------------
write_sef_all_vars <- function(df_vars, name, code, lat, lon, alt, outdir,
meta_head_p = "", meta_head_all = "",
source = "KNMI", time_offset_bool = FALSE,
link = "https://www.knmi.nl/nederland-nu/klimatologie/daggegevens/antieke-waarnemingen") {
base_cols <- df_vars %>% select(Year, Month, Day, Hour, Minute)
vars_possibilities <-  c("dd","p","ta","rr", "rh")
# select the actual variables found in the df
vars <- vars_possibilities[vars_possibilities %in% names(df_vars)]
if (!length(vars)) {
cat("  (no writeable variables found)\n")
return(invisible(NULL))
}
# make directory if it doesn't exist
station_dir <- file.path(outdir, name)
if (!dir.exists(station_dir)) {
dir.create(station_dir, recursive = TRUE)
cat("  Created directory:", station_dir, "\n")
}
# calculate time_offset if there is
time_offset <- if (time_offset_bool) time.offset(lon) else 0L
for (var in vars) {
# join metaHeads if more than one
metaheads <- c(
if (!is.na(meta_head_all) && nzchar(meta_head_all)) meta_head_all else NULL,
if (var=="p" && !is.na(meta_head_p) && nzchar(meta_head_p)) meta_head_p else NULL
)
metaHead <- if (length(metaheads)) paste(metaheads, collapse = " | ") else ""
# select proper meta column
metaname <- paste0("meta.", var)
metavec  <- if(metaname %in% names(df_vars)) {
df_vars[[metaname]]
} else {
rep("", nrow(df_vars))
}
dat <- bind_cols(base_cols, setNames(df_vars[var], var))
# skip variables with no valid data
if (all(is.na(dat[[var]]))) {
cat("  → Skipping", var, "(no non-NA values)\n")
next
}
cat("  → Writing", var, "rows:", sum(!is.na(dat[[var]])), "/", nrow(dat), "\n")
write_sef_f(
as.data.frame(dat),
outfile  = outfile.name(name, var, dat, TRUE),
outpath  = file.path(outdir, name),
cod      = code,
lat      = lat,
lon      = lon,
alt      = alt,
sou      = source,
link     = link,
nam      = name,
var      = var,
stat     = "point",
period   = 0L,
units    = units(var),
meta     = metavec,
metaHead = metaHead,
time_offset = time_offset,
keep_na  = FALSE
)
}
}
# ---- 5) Station registry -------------------------------------------
stations <- read_csv("/scratch3/PALAEO-RA/daily_data/original/knmi-inventory.csv")
# convert column of file order:
stations$file_order <- lapply(stations$file_order, function(x) {
if (is.null(x) || is.na(x)) return(NULL)
as.numeric(unlist(strsplit(gsub(" ", "", x), ",")))
})
# filter stations to use now
if (!is.na(STATION_NAME)) {
stations <- stations[grepl(STATION_NAME, stations$name), ]
}
print(stations)
# ---- 6) One driver to process a station row ---------------------------------
process_station <- function(st_row) {
cat("\n====================\nProcessing station:", st_row$name, "\n")
all_files <- list.files(st_row$dir, full.names = TRUE)
# Filter by pattern if specified
if (!is.na(st_row$file_pattern[[1]])) {
all_files <- all_files[grepl(st_row$file_pattern[[1]], basename(all_files))]
}
# Reorder if specified
if (!is.null(st_row$file_order[[1]])) {
all_files <- all_files[st_row$file_order[[1]]]
}
if (length(all_files) == 0) {
cat("  !! No files found for", st_row$name, "→ skipping\n")
return(invisible(NULL))
}
raw  <- read_knmi_files(all_files, skip = st_row$skip)
df   <- stamp_time(raw)
has_hour <- (("hh"   %in% names(raw)) && any(!is.na(raw$hh))) ||
(("hhmm" %in% names(raw)) && any(!is.na(raw$hhmm)))
df_vars <- compute_vars(
df,
lat = st_row$lat,
lon = st_row$lon,
alt = st_row$alt,
ta_scale  = st_row$ta_scale %||% NA_character_,
p_mode    = st_row$p_mode %||% NA_character_,
rr_factor = st_row$rr_factor %||% NA_real_
)
summarise_station(st_row$name, OUTDIR, df_vars)
write_sef_all_vars(
df_vars,
name = st_row$name,
code = st_row$code,
lat = st_row$lat,
lon = st_row$lon,
alt = st_row$alt,
outdir = OUTDIR,
meta_head_p   = st_row$meta_head_p,
meta_head_all = st_row$meta_head_all,
time_offset_bool = has_hour
)
cat("  ✓ Completed", st_row$name, "\n")
}
summarise_station <- function(name, outdir, df_vars) {
cat("\n--- Summary for", name, "---\n")
vars <- intersect(c("dd","p","ta","rr","rh"), names(df_vars))
for (v in vars) {
n_non_na <- sum(!is.na(df_vars[[v]]))
n_total  <- nrow(df_vars)
rng <- if (is.numeric(df_vars[[v]])) {
paste0("[", suppressWarnings(min(df_vars[[v]], na.rm=TRUE)), ", ",
suppressWarnings(max(df_vars[[v]], na.rm=TRUE)), "]")
} else {
# e.g. 'dd' can be "calm" or "135"
paste0("examples: ", paste(head(unique(df_vars[[v]]), 3), collapse=", "))
}
cat(sprintf("  %s: %d/%d non-NA; %s\n", v, n_non_na, n_total, rng))
}
dest <- file.path(outdir, name)
if (dir.exists(dest)) {
wrote <- list.files(dest, full.names = FALSE)
cat("  Files in output dir:", length(wrote), "\n")
if (length(wrote)) cat("   ", paste(head(wrote, 8), collapse="  "), if (length(wrote)>8) " ..." else "", "\n")
} else {
cat("  (Output directory does not exist yet)\n")
}
}
# ---- 7) Run everything -------------------------------------------------------
for (i in seq_len(nrow(stations))) {
st_row <- stations[i, ]
process_station(st_row)
}
read.tsv?
das
?read.tsv
?read.delim
df<-read.delim(file="/scratch3/PALAEO-RA/daily_data/final/Schaffhausen/SH01_Schaffhausen.tsv", header=TRUE)
df<-read.delim(file="/scratch3/PALAEO-RA/daily_data/original/Schaffhausen/SH01_Schaffhausen.tsv", header=TRUE)
df
na_cols <- names(df)[colSums(!is.na(df)) == 0]
na_cols
df <- df[, colSums(!is.na(df)) > 0]
df
names(df)
rm(list=ls())
library(dataresqc)
library(readxl)
library(tidyr)
library(dplyr)
library(lubridate)
source('/home/ccorbella/scratch2_symboliclink/code/KF_assimilation/dataprep/helpfun.R')
outdir <- "/scratch3/PALAEO-RA/daily_data/final/Venice"
code <- "Venezia"
code <- "Venezia"
source('/scratch2/ccorbella/KF_assimilation/dataprep/helpfun.R')
source('/scratch2/ccorbella/code/dataprep/helpfun.R')
outdir <- "/scratch3/PALAEO-RA/daily_data/final/Venice"
name <- "Venice"
code <- "Venezia"
lat	<- 45.44
lon	<- 12.33
alt	<- NA
source <- " Camuffo, D., della Valle, A., & Becherini, F. (2025). Temperature and Pressure Observations by Tommaso Temanza from 1751 to 1769 in Venice, Italy. Climate, 13(10), 217."
link   <- " https://doi.org/10.3390/cli13100217 "
metaHead.p <- "Observer=Tommaso Temanza | Instrumet=Amontons thermometer (1751-1759), Réaumur thermometer (1761-1769) | exact location unknown"
metaHead.ta <- "Observer=Tommaso Temanza | exact location unknown"
file <- "/scratch3/PALAEO-RA/daily_data/original/Venice/Venice_temperature_by_Temanza.csv"
raw <- read_excel(file)
raw <- read_delim(file)
raw <- read.delim(file)
raw
raw <- read.delim(file, sep="\t")
raw
raw <- read.csv(file, sep="\t")
raw
raw <- read.table(file, header=TRUE)
raw <- read_delim(file, header=TRUE)
raw <- read.delim(file, header=TRUE)
head(raw)
raw <- read.delim(file, delim= " ")
raw <- read.delim(file, delim = " ")
raw <- read.csv(file)
head(raw)
raw
head(raw)
?rename
colnames(raw)[4] <- "ta"
head(raw)
df <- raw %>%
add_column(Hour=12, Minute=0, .before=ta)
library(dplyr)
df <- raw %>%
add_column(Hour=12, Minute=0, .before=ta)
?add_column
library(tibble)
df <- raw %>%
add_column(Hour=12, Minute=0, .before=ta)
rm(list=ls())
library(dataresqc)
library(readxl)
library(tidyr)
library(dplyr)
library(lubridate)
library(tibble)
source('/scratch2/ccorbella/code/dataprep/helpfun.R')
outdir <- "/scratch3/PALAEO-RA/daily_data/final/Venice"
name <- "Venice"
code <- "Venezia"
lat	<- 45.44
lon	<- 12.33
alt	<- NA
source <- " Camuffo, D., della Valle, A., & Becherini, F. (2025). Temperature and Pressure Observations by Tommaso Temanza from 1751 to 1769 in Venice, Italy. Climate, 13(10), 217."
link   <- " https://doi.org/10.3390/cli13100217 "
metaHead.p <- "Observer=Tommaso Temanza | Instrumet=Amontons thermometer (1751-1759), Réaumur thermometer (1761-1769) | exact location unknown"
metaHead.ta <- "Observer=Tommaso Temanza | PGC=N | exact location unknown"
file <- "/scratch3/PALAEO-RA/daily_data/original/Venice/Venice_temperature_by_Temanza.csv"
raw <- read.csv(file)
colnames(raw)[4] <- "ta"
head(raw)
df <- raw %>%
add_column(Hour=12, Minute=0, .before=ta)
df <- raw %>%
add_column(Hour=12, Minute=0, .before="ta")
raw <- read.csv(file)
colnames(raw)[4] <- "ta"
head(raw)
df <- raw %>%
add_column(Hour=12, Minute=0, .before="ta") %>%
mutate(meta="obs.time=solar_noon")
head(df)
?outfile.name
write_sef_f(
as.data.frame(df),
outfile  = outfile.name(code, var, df, subdaily="noon"),
outpath  = outdir,
cod      = code,
lat      = lat,
lon      = lon,
alt      = alt,
sou      = source,
link     = link,
nam      = name,
var      = var,
stat     = "point",
units    = "C",
metaHead = metaHead.ta,
meta     = df$meta,
keep_na  = FALSE
)
outfile.name(code, var, df, subdaily="noon")
var
var <- "ta"
write_sef_f(
as.data.frame(df),
outfile  = outfile.name(code, var, df, subdaily="noon"),
outpath  = outdir,
cod      = code,
lat      = lat,
lon      = lon,
alt      = alt,
sou      = source,
link     = link,
nam      = name,
var      = var,
stat     = "point",
units    = "C",
metaHead = metaHead.ta,
meta     = df$meta,
keep_na  = FALSE
)
file <- "/scratch3/PALAEO-RA/daily_data/original/Venice/Venice_pressure_by_Temanza.csv"
raw <- read.csv(file)
colnames(raw)[4] <- "p"
head(raw)
write_sef_f(
as.data.frame(df),
outfile  = outfile.name(code, var, df, subdaily="noon"),
outpath  = outdir,
cod      = code,
lat      = lat,
lon      = lon,
alt      = alt,
sou      = source,
link     = link,
nam      = name,
var      = var,
stat     = "point",
units    = "C",
metaHead = metaHead.ta,
meta     = df$meta,
time_offset = time.offset(lon),
keep_na  = FALSE
)
)
df <- raw %>%
add_column(Hour=12, Minute=0, .before="ta") %>%
mutate(meta=paste0(
"obs.time=solar_noon",
ifelse(outlier==0,"","qc=outlier")
)
)
df <- raw %>%
add_column(Hour=12, Minute=0, .before="p") %>%
mutate(meta=paste0(
"obs.time=solar_noon",
ifelse(outlier==0,"","qc=outlier")
)
)
head(df)
var <- "p"
df <- raw %>%
add_column(Hour=12, Minute=0, .before="p") %>%
mutate(meta=paste0(
"obs.time=solar_noon",
ifelse(outlier==0,""," | qc=outlier")
)
)
head(df)
var <- "p"
write_sef_f(
as.data.frame(df),
outfile  = outfile.name(code, var, df, subdaily="noon"),
outpath  = outdir,
cod      = code,
lat      = lat,
lon      = lon,
alt      = alt,
sou      = source,
link     = link,
nam      = name,
var      = var,
stat     = "point",
units    = "C",
metaHead = metaHead.p,
meta     = df$meta,
time_offset = time.offset(lon),
keep_na  = FALSE
)
head(raw)
df <- raw %>%
add_column(Hour=12L, Minute=0L, .before="p") %>%
mutate(
year=as.numeric(year),
month=as.numeric(month),
day=as.numeric(day),
meta=paste0(
"obs.time=solar_noon",
ifelse(outlier==0,""," | qc=outlier")
)
)
head(df)
var <- "p"
write_sef_f(
as.data.frame(df),
outfile  = outfile.name(code, var, df, subdaily="noon"),
outpath  = outdir,
cod      = code,
lat      = lat,
lon      = lon,
alt      = alt,
sou      = source,
link     = link,
nam      = name,
var      = var,
stat     = "point",
units    = "C",
metaHead = metaHead.p,
meta     = df$meta,
time_offset = time.offset(lon),
keep_na  = FALSE
)
outfile.name(code, var, df, subdaily="noon")
fd
df
get_date_range(df)
file <- "/scratch3/PALAEO-RA/daily_data/original/Venice/Venice_pressure_by_Temanza.csv"
raw <- read.csv(file)
source('/scratch2/ccorbella/code/dataprep/helpfun.R')
colnames(raw)[4] <- "p"
head(raw)
df <- raw %>%
add_column(Hour=12L, Minute=0L, .before="p") %>%
mutate(
meta=paste0(
"obs.time=solar_noon",
ifelse(outlier==0,""," | qc=outlier")
)
)
head(df)
var <- "p"
write_sef_f(
as.data.frame(df),
outfile  = outfile.name(code, var, df, subdaily="noon"),
outpath  = outdir,
cod      = code,
lat      = lat,
lon      = lon,
alt      = alt,
sou      = source,
link     = link,
nam      = name,
var      = var,
stat     = "point",
units    = "C",
metaHead = metaHead.p,
meta     = df$meta,
time_offset = time.offset(lon),
keep_na  = FALSE
)
file <- "/scratch3/PALAEO-RA/daily_data/original/Venice/Venice_temperature_by_Temanza.csv"
raw <- read.csv(file)
colnames(raw)[4] <- "ta"
head(raw)
df <- raw %>%
add_column(Hour=12, Minute=0, .before="ta") %>%
mutate(meta="obs.time=solar_noon")
head(df)
var <- "ta"
write_sef_f(
as.data.frame(df),
outfile  = outfile.name(code, var, df, subdaily="noon"),
outpath  = outdir,
cod      = code,
lat      = lat,
lon      = lon,
alt      = alt,
sou      = source,
link     = link,
nam      = name,
var      = var,
stat     = "point",
units    = "C",
metaHead = metaHead.ta,
meta     = df$meta,
keep_na  = FALSE
)
library(dataresqc)
library(hclim)
source('/home/ccorbella/scratch2_symboliclink/code/dataprep/helpfun.R')
library(glue)
indir <- '/scratch3/PALAEO-RA/daily_data/final/'
### quick one
dirname <- "Venice/"
filename <- "Venezia_17510101-17691231_ta_noon.tsv"
qc(glue(indir,dirname,filename), outpath=glue(indir, dirname))
qcfilename <- "qc_Venezia_ta_subdaily.txt"
write_flags_f(infile=glue(indir,dirname,filename),
qcfile=glue(indir,dirname, qcfilename),
outpath=glue(indir,dirname),
match=FALSE)
filename <- "Venezia_17510101-17590430_p_noon.tsv"
qc(glue(indir,dirname,filename), outpath=glue(indir, dirname))
units(var)
qc(glue(indir,dirname,filename), outpath=glue(indir, dirname))
qcfilename <- "qc_Venezia_p_subdaily.txt"
write_flags_f(infile=glue(indir,dirname,filename),
qcfile=glue(indir,dirname, qcfilename),
outpath=glue(indir,dirname),
match=FALSE)
