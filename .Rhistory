lon = -0.38,
alt = 25,
Source = "Dominguez_Castro_2014",
Link = "https://docta.ucm.es/entities/publication/b26dac98-5ffe-482c-9419-2f94168cc7eb"
)
df.ta <- all_df %>%
mutate(
meta=meta_time(Hour, Minute)
) %>% select(Year, Month, Day, Hour, Minute, Term, meta)
df.p <- all_df %>%
mutate(
p = round(convert_pressure(as.numeric(Bar_p) + as.numeric(Bar_l)/12, f=27.07, lat=meta[["lat"]], alt=meta[["alt"]],
atb=Term),2),
meta=paste0(meta_time(Hour, Minute), " | orig=", Bar_p, "in", Bar_l, "l | atb=", Term, "C")
) %>% select(Year, Month, Day, Hour, Minute, p, meta)
# clean winds for Valenica
dd_preclean <- function(x) {
y <- toupper(trimws(x))
y <- gsub("^M\\.?\\s*[0-9]+\\.?$", "M", y)
# drop numbers, dots, stray punctuation
y <- gsub("[0-9\\.]", "", y)
y <- gsub("-", "", y)
recode(y,
# Valencian / Spanish names
"L"      = "E",   "LEV"    = "E",   "LEVECHE" = "SE",
"P"      = "W",   "PON"    = "W",
"M"      = "S",   "MIGJORN"= "S",
"T"      = "N",   "TRAMUNTANA" = "N",
"TRE"    = "N",
# French / mixed spellings
"OUESTE" = "W",
"OUEST"  = "W",
"NOR"    = "N",
"NORT"   = "N",
"SUD"    = "S",
"EST"    = "E",
"ESTNOR" = "ENE",
"SUDEST"="SE",
# compound textual forms
"ESTNORD" = "ENE",
"NOREST"  = "NE",
"NORDESTE" = "NE",
"ESTSUD"  = "ESE",
"EES" = "ESE",
"SUDES"   = "SE",
"NORNOR"  = "NNW",
"SUDSUD"  = "SSW",
"OUESTSUD"= "WSW",
"ESTE" ="E",
"NOROUE"  = "NW",
"ESTSUDE" = "SE",
# weird abbreviations
"ON"  = "WNW",
"NON" = "NNW",
"ONO" = "WNW",
"OSO" = "WSW",
"NOO" = "NW",
"OO"  = "W",
"EE"  = "E",
"OS" = "SW",
"EN" = "NE",
"SSS" = "S",
"SP" = "SW",
"MNE" = "E",
"SS" ="S",
"ME" = "SE",
.default = y,
.missing = NA_character_
)
}
df.dd <- all_df %>%
mutate(
orig_dd_clean = dd_preclean(orig_dd),
dd.norm = dd_normalize(orig_dd_clean),
dd = dd2deg(dd.norm),
meta=paste0(meta_time(Hour, Minute), " | orig=", orig_dd)
) %>% select(Year, Month, Day, Hour, Minute, dd, meta)
# check which winds didn't get converted
# (need to select orig_dd and orig_dd_clean columns beforehand)
df.dd %>%
filter(is.na(dd), !is.na(orig_dd)) %>%
select(Year, Month, Day, dd, orig_dd, orig_dd_clean, meta)
# ta
var <- "ta"
write_sef_f(Data=as.data.frame(df.ta),
outfile=outfile.name(meta[["Name"]], var, df.ta, subdaily=TRUE),
outpath=outdir,
cod=meta[["ID"]],
variable=var,
nam=meta[["Name"]],
lat=meta[["lat"]],
lon=meta[["lon"]], alt=meta[["alt"]], sou=meta[["Source"]],
link=meta[["Link"]], units=units(var), stat="point",
time_offset = time.offset(meta[["lon"]]),
meta=df.ta$meta, keep_na = T)
# p
var<-"p"
write_sef_f(Data=as.data.frame(df.p),
outfile=outfile.name(meta[["Name"]], var, df.p, subdaily=TRUE),
outpath=outdir,
cod=meta[["ID"]],
variable=var,
nam=meta[["Name"]],
lat=meta[["lat"]],
lon=meta[["lon"]], alt=meta[["alt"]], sou=meta[["Source"]],
units=units(var),
link=meta[["Link"]], stat="point",
time_offset=time.offset(meta[["lon"]]),
meta=df.p$meta, keep_na =TRUE)
# dd
var<-'dd'
write_sef_f(Data=as.data.frame(df.dd),
outfile=outfile.name(meta[["Name"]], var, df.dd, subdaily=TRUE),
outpath=outdir,
cod=meta[["ID"]],
variable=var,
nam=meta[["Name"]],
lat=meta[["lat"]],
lon=meta[["lon"]], alt=meta[["alt"]], sou=meta[["Source"]],
units=units(var),
link=meta[["Link"]], stat="point",
time_offset=time.offset(meta[["lon"]]),
meta=df.dd$meta, keep_na =TRUE)
source("/scratch2/ccorbella/code/dataprep/indiv_series/Valencia.R", echo=TRUE)
all_df
tail(all_df)
# ta
var <- "ta"
df.ta
tail(df.ta)
# ta
var <- "ta"
write_sef_f(Data=as.data.frame(df.ta),
outfile=outfile.name(meta[["Name"]], var, df.ta, subdaily=TRUE),
outpath=outdir,
cod=meta[["ID"]],
variable=var,
nam=meta[["Name"]],
lat=meta[["lat"]],
lon=meta[["lon"]], alt=meta[["alt"]], sou=meta[["Source"]],
link=meta[["Link"]], units=units(var), stat="point",
time_offset = time.offset(meta[["lon"]]),
meta=df.ta$meta, keep_na = T)
# p
var<-"p"
write_sef_f(Data=as.data.frame(df.p),
outfile=outfile.name(meta[["Name"]], var, df.p, subdaily=TRUE),
outpath=outdir,
cod=meta[["ID"]],
variable=var,
nam=meta[["Name"]],
lat=meta[["lat"]],
lon=meta[["lon"]], alt=meta[["alt"]], sou=meta[["Source"]],
units=units(var),
link=meta[["Link"]], stat="point",
time_offset=time.offset(meta[["lon"]]),
meta=df.p$meta, keep_na =TRUE)
# dd
var<-'dd'
write_sef_f(Data=as.data.frame(df.dd),
outfile=outfile.name(meta[["Name"]], var, df.dd, subdaily=TRUE),
outpath=outdir,
cod=meta[["ID"]],
variable=var,
nam=meta[["Name"]],
lat=meta[["lat"]],
lon=meta[["lon"]], alt=meta[["alt"]], sou=meta[["Source"]],
units=units(var),
link=meta[["Link"]], stat="point",
time_offset=time.offset(meta[["lon"]]),
meta=df.dd$meta, keep_na =TRUE)
library(glue)
indir <- '/scratch3/PALAEO-RA/daily_data/final/'
### quick one
dirname <- "Valencia/"
files <- list.files(paste0(indir, dirname), pattern = "\\.tsv$", full.names = TRUE)
files
for (f in files) {
qc(f, outpath = paste0(indir,dirname))
qcfile <- file.path(
indir,
paste0("qc_", tools::file_path_sans_ext(basename(f)), ".txt")
)
}
qc_files  <- list.files(paste0(indir, dirname), pattern="^qc_.*\\.txt$", full.names=TRUE)
qc_files
# Valencia ----------------------------------------------------------------
for (var in c("ta", "dd", "p")) {
filename <- paste0("DominguezCastro_Valencia_17900629-18611231_", var,"_subdaily.tsv")
qcfilename <- pasteo("qc_Valencia_", var, "_subdaily.txt")
write_flags_f(infile=glue(indir,dirname,filename),
qcfile=glue(indir,dirname, qcfilename),
outpath=glue(indir,dirname),
match=FALSE)
}
# Valencia ----------------------------------------------------------------
for (var in c("ta", "dd", "p")) {
filename <- paste0("DominguezCastro_Valencia_17900629-18611231_", var,"_subdaily.tsv")
qcfilename <- paste0("qc_Valencia_", var, "_subdaily.txt")
write_flags_f(infile=glue(indir,dirname,filename),
qcfile=glue(indir,dirname, qcfilename),
outpath=glue(indir,dirname),
match=FALSE)
}
rm(list=ls())
library(dplyr)
library(readr)
library(purrr)
files <- list.files(pattern = "/scratch3/PALAEO-RA/daily_data/tmp/Lucas/(SFP|SLP)\\.csv$", full.names = TRUE)
files
files <- list.files(pattern = "/scratch3/PALAEO-RA/daily_data/tmp/Lucas/(SFP|SLP)\\.csv$", full.names = TRUE)
files
files <- list.files(pattern = "/scratch3/PALAEO-RA/daily_data/tmp/Lucas/*(SFP|SLP)\\.csv$", full.names = TRUE)
files
files <- list.files(
path = "/scratch3/PALAEO-RA/daily_data/tmp/Lucas",
pattern = "^[A-Z]{3}_(SFP|SLP)\\.csv$",
full.names = TRUE
)
files
filesout <- map_dfr(files, function(f) {
df <- read_csv(f, show_col_types = FALSE)
val_col <- names(df)[2]  # SFP or SLP
df_valid <- df %>% filter(!is.na(.data[[val_col]]))
tibble(
file = basename(f),
start_date = if (nrow(df_valid) > 0) min(df_valid$dates) else NA,
end_date   = if (nrow(df_valid) > 0) max(df_valid$dates) else NA
)
})
out
filesout
rm(list=ls())
library(dplyr)
library(readxl)
source('/scratch2/ccorbella/code/dataprep/helpfun.R')
name <- "Yuri_Nuuk"
code <- "Nuuk"
source <- "Brugnara, Y., Auchmann, R., Brönnimann, S., Allan, R. J., Auer, I., Barriendos, M., Bergström, H., Bhend, J., Brázdil, R., Compo, G. P., Cornes, R. C., Dominguez-Castro, F., van Engelen, A. F. V., Filipiak, J., Holopainen, J., Jourdain, S., Kunz, M., Luterbacher, J., Maugeri, M., Mercalli, L., Moberg, A., Mock, C. J., Pichard, G., Řezníčková, L., van der Schrier, G., Slonosky, V., Ustrnul, Z., Valente, M. A., Wypych, A., and Yin, X.: A collection of sub-daily pressure and temperature observations for the early instrumental period with a focus on the `year without a summer` 1816, Clim. Past, 11, 1027–1047, 2015."
link   <- "https://doi.org/10.5194/cp-11-1027-2015"
metaHead <- "coords=approx."
raw <- read_excel("/scratch3/PALAEO-RA/daily_data/original/Nuuk/Pressure_Nuuk.xls")
raw <- read_excel("/scratch3/PALAEO-RA/daily_data/original/Nuuk/Pressure_Greenland.xls")
raw
?read_excel
raw <- read_excel("/scratch3/PALAEO-RA/daily_data/original/Nuuk/Pressure_Greenland.xls",
col_names=c("year", "month", "day", "p1", "l1", "p2", "l2", "p3", "l3"))
ra
raw
raw <- read_excel("/scratch3/PALAEO-RA/daily_data/original/Nuuk/Pressure_Greenland.xls",
skip=1,
col_names=c("year", "month", "day", "p1", "l1", "p2", "l2", "p3", "l3"))
raw
?pivot_longer
library(purrr)
library(tidyr)
?pivot_longer
df <- raw %>%
pivot_longer(
cols = p1:l3,
names_to = c(".value", "obs.num"),
names_pattern = "(p|l)(\\d)"
)
df
df <- raw %>%
pivot_longer(
cols = p1:l3,
names_to = c(".value", "obs.num"),
names_pattern = "(p|l)(\\d)"
) %>% mutate(
Hour=case_when(
obs.num==1 ~ 7L,
obs.num==2 ~ 13L,
obs.num==3 ~ 19L
),
Minute = 0L,
p = round(convert_pressure(p=(p+l/12), f=27.07, lat=lat, alt=alt),2),
meta = paste0("obs.num=", obs.num, " | orig=",p,"in", l,"l")
)
lat <- 64.1877
lon <- -51.6756
alt <- 10
name <- "Yuri_Nuuk"
code <- "Nuuk"
source <- "Brugnara, Y., Auchmann, R., Brönnimann, S., Allan, R. J., Auer, I., Barriendos, M., Bergström, H., Bhend, J., Brázdil, R., Compo, G. P., Cornes, R. C., Dominguez-Castro, F., van Engelen, A. F. V., Filipiak, J., Holopainen, J., Jourdain, S., Kunz, M., Luterbacher, J., Maugeri, M., Mercalli, L., Moberg, A., Mock, C. J., Pichard, G., Řezníčková, L., van der Schrier, G., Slonosky, V., Ustrnul, Z., Valente, M. A., Wypych, A., and Yin, X.: A collection of sub-daily pressure and temperature observations for the early instrumental period with a focus on the `year without a summer` 1816, Clim. Past, 11, 1027–1047, 2015."
link   <- "https://doi.org/10.5194/cp-11-1027-2015"
metaHead <- "coords=approx."
raw <- read_excel("/scratch3/PALAEO-RA/daily_data/original/Nuuk/Pressure_Greenland.xls",
skip=1,
col_names=c("year", "month", "day", "p1", "l1", "p2", "l2", "p3", "l3"))
df <- raw %>%
pivot_longer(
cols = p1:l3,
names_to = c(".value", "obs.num"),
names_pattern = "(p|l)(\\d)"
) %>% mutate(
Hour=case_when(
obs.num==1 ~ 7L,
obs.num==2 ~ 13L,
obs.num==3 ~ 19L
),
Minute = 0L,
p = round(convert_pressure(p=(p+l/12), f=27.07, lat=lat, alt=alt),2),
meta = paste0("obs.num=", obs.num, " | orig=",p,"in", l,"l")
)
df
df <- raw %>%
pivot_longer(
cols = p1:l3,
names_to = c(".value", "obs.num"),
names_pattern = "(p|l)(\\d)"
) %>% mutate(
Hour=case_when(
obs.num==1 ~ 7L,
obs.num==2 ~ 13L,
obs.num==3 ~ 19L
),
Minute = 0L,
phPa = round(convert_pressure(p=(p+l/12), f=27.07, lat=lat, alt=alt),2),
meta = paste0("obs.num=", obs.num, " | orig=",p,"in", l,"l")
) %>% select(year, month, day, Hour, Minute, phPa, meta)
df
head(df)
# save
var <-"p"
write_sef_f(
as.data.frame(df),
outfile = outfile.name(name, var, df, TRUE),
outpath = outdir,
cod     = code,
lat     = lat,
lon     = lon,
alt     = alt,
sou     = source,
link    = link,
nam     = name,
var     = var,
stat    = "point",
units   = units(var),
metaHead = "PTC=N | PGC=Y",
meta    = df$meta,
keep_na = TRUE
)
outdir <- "/scratch3/PALAEO-RA/daily_data/final/Nuuk"
write_sef_f(
as.data.frame(df),
outfile = outfile.name(name, var, df, TRUE),
outpath = outdir,
cod     = code,
lat     = lat,
lon     = lon,
alt     = alt,
sou     = source,
link    = link,
nam     = name,
var     = var,
stat    = "point",
units   = units(var),
metaHead = "PTC=N | PGC=Y",
meta    = df$meta,
keep_na = TRUE
)
library(glue)
indir <- '/scratch3/PALAEO-RA/daily_data/final/'
### quick one
dirname <- "Nuuk/"
filename <- "Yuri_Nuuk_18160101-18201231_p_subdaily.tsv"
qc(glue(indir,dirname,filename), outpath=glue(indir, dirname))
qcfilename <- "qc_Nuuk_p_subdaily.txt"
write_flags_f(infile=glue(indir,dirname,filename),
qcfile=glue(indir,dirname, qcfilename),
outpath=glue(indir,dirname),
match=FALSE)
rm(list=ls())
library(dplyr)
library(readxl)
library(purrr)
library(tidyr)
source('/scratch2/ccorbella/code/dataprep/helpfun.R')
outdir <- "/scratch3/PALAEO-RA/daily_data/final/Althorp"
lat <- 52.28
lon <- -1
alt <- 105
name <- "Yuri_Althorp"
code <- "Althorp"
source <- "Brugnara, Y., Auchmann, R., Brönnimann, S., Allan, R. J., Auer, I., Barriendos, M., Bergström, H., Bhend, J., Brázdil, R., Compo, G. P., Cornes, R. C., Dominguez-Castro, F., van Engelen, A. F. V., Filipiak, J., Holopainen, J., Jourdain, S., Kunz, M., Luterbacher, J., Maugeri, M., Mercalli, L., Moberg, A., Mock, C. J., Pichard, G., Řezníčková, L., van der Schrier, G., Slonosky, V., Ustrnul, Z., Valente, M. A., Wypych, A., and Yin, X.: A collection of sub-daily pressure and temperature observations for the early instrumental period with a focus on the `year without a summer` 1816, Clim. Past, 11, 1027–1047, 2015."
link   <- "https://doi.org/10.5194/cp-11-1027-2015"
raw <- read_excel("/scratch3/PALAEO-RA/daily_data/original/Althorp/Althorp.xls",
skip=10)
raw
df <- raw %>%
pivot_longer(
cols = P1:TA2,
names_to = c(".value", "obs.num"),
names_pattern = "(P|TA)(\\d)"
)
df
df <- raw %>%
pivot_longer(
cols = P1:TA2,
names_to = c(".value", "obs.num"),
names_pattern = "(P|TA)(\\d)"
) %>% mutate(
Hour=case_when(
obs.num==1 ~ 8L,
obs.num==2 ~ 18L,
),
Minute = 0L,
phPa = round(convert_pressure(p=P, f=25.04, lat=lat, alt=alt),2),
taC = round((TA- 32) / 1.8,2),
meta.time=case_when(
obs.num==1 ~ "morning",
obs.num==2 ~ "evening",
),
meta.p = paste0("obs.time=", meta.time, " | orig=",p,"in", l,"l | atb=", TA, "F"),
meta.ta = paste0("obs.time=", meta.time, " | orig=",TA, "F"),
) %>% select(year, month, day, Hour, Minute, phPa, taC, meta.ta, meta.p)
df <- raw %>%
pivot_longer(
cols = P1:TA2,
names_to = c(".value", "obs.num"),
names_pattern = "(P|TA)(\\d)"
) %>% mutate(
Hour=case_when(
obs.num==1 ~ 8L,
obs.num==2 ~ 18L,
),
Minute = 0L,
phPa = round(convert_pressure(p=P, f=25.04, lat=lat, alt=alt),2),
taC = round((TA- 32) / 1.8,2),
meta.time=case_when(
obs.num==1 ~ "morning",
obs.num==2 ~ "evening",
),
meta.p = paste0("obs.time=", meta.time, " | orig=",P,"English in | atb=", TA, "F"),
meta.ta = paste0("obs.time=", meta.time, " | orig=",TA, "F"),
) %>% select(year, month, day, Hour, Minute, phPa, taC, meta.ta, meta.p)
df <- raw %>%
pivot_longer(
cols = P1:TA2,
names_to = c(".value", "obs.num"),
names_pattern = "(P|TA)(\\d)"
) %>% mutate(
Hour=case_when(
obs.num==1 ~ 8L,
obs.num==2 ~ 18L,
),
Minute = 0L,
phPa = round(convert_pressure(p=P, f=25.04, lat=lat, alt=alt),2),
taC = round((TA- 32) / 1.8,2),
meta.time=case_when(
obs.num==1 ~ "morning",
obs.num==2 ~ "evening",
),
meta.p = paste0("obs.time=", meta.time, " | orig=",P,"English in | atb=", TA, "F"),
meta.ta = paste0("obs.time=", meta.time, " | orig=",TA, "F"),
) %>% select(Year, Month, Day, Hour, Minute, phPa, taC, meta.ta, meta.p)
head(df)
# save
var <-"p"
write_sef_f(
as.data.frame(df[,c("Year","Month", "Day", "Hour", "Minute", "phPa")]),
outfile = outfile.name(name, var, df, TRUE),
outpath = outdir,
cod     = code,
lat     = lat,
lon     = lon,
alt     = alt,
sou     = source,
link    = link,
nam     = name,
var     = var,
stat    = "point",
units   = units(var),
metaHead = "PTC=Y | PGC=Y",
meta    = df$meta.p,
keep_na = TRUE
)
source("/scratch2/ccorbella/code/dataprep/indiv_series/Althorp.R", echo=TRUE)
var <-"ta"
write_sef_f(
as.data.frame(df[,c("Year","Month", "Day", "Hour", "Minute", "taC")]),
outfile = outfile.name(name, var, df, TRUE),
outpath = outdir,
cod     = code,
lat     = lat,
lon     = lon,
alt     = alt,
sou     = source,
link    = link,
nam     = name,
var     = var,
stat    = "point",
units   = units(var),
meta    = df$meta.ta,
keep_na = TRUE
)
library(glue)
indir <- '/scratch3/PALAEO-RA/daily_data/final/'
### quick one
dirname <- "Althorp/"
files <- list.files(paste0(indir, dirname), pattern = "\\.tsv$", full.names = TRUE)
files
for (f in files) {
qc(f, outpath = paste0(indir,dirname))
qcfile <- file.path(
indir,
paste0("qc_", tools::file_path_sans_ext(basename(f)), ".txt")
)
}
qc_files  <- list.files(paste0(indir, dirname), pattern="^qc_.*\\.txt$", full.names=TRUE)
qc_files
